## Objective

`xstat` module is responsible for creating, retrieving, and storing the `xattr` data onto files or folders.

For the sake of performance, it also returns `fs.stat` (via `lstat`) data to caller. Hence the name `xstat` stands for `xattr` + `fs.stat`.

**using lstat rather than stat** to avoid following symbolic link.

## Data Structure Definition

There are two data structures.

One is stored as `xattr` using `user:fruitmix` as name in json format, representing the decorated file metadata.

The other is returned by read function to upper layer, in JavaScript object format, representing a file or folder's merged file system metadata.

### xattr in JSON format

example:

```json
{
  "uuid": "d10a0dce-7ff6-4cdd-b02b-f74fc863b0fd",
  "writelist": [],
  "readlist": [],
  "hash": "7803e8fa1b804d40d412bcd28737e3ae027768ecc559b51a284fbcadcd0e21be",
  "htime": 1482051736410,
  "magic": "JPEG"  
}
```

**uuid**

mandatory, a valid uuid v4 string

**writelist and readlist**

mandatory, both are uuid v4 string array, or both are null. It is not allowed that one is uuid array and the other are null. Empty array is OK.

**hash and htime**

optional. Both exists or both are absent. One existing and the other absent is invalid.

`hash` is a sha256 string and could be validated by regex. `htime` is an integer, usually generated by `new Date().getTime()`.

**magic**

A predefined string, such as `JPEG`, or a number, used as `uninterested magic version`. Starting from 0. Bumped when more file-types supported.

#### bad format

If `xstat` module reads a `xattr` that does not conform to above definition. It should be discarded. The file or folder is treated as no `xattr` at all.

#### old format

In previous software version, there are one extra prop (`owner`) in JSON, and magic prop has different definition.

example:

```json
{
  "owner": [],
  "magic": "JPEG image data, Exif standard: [TIFF image data, little-endian..."
}
```

If a `xattr` have all props valid (except for mgaic), and it has `owner` prop which is an empty or uuid array, it should be considered an old version. And old version should be translated into new definition, rather than treating it as bad format.

If an old version is detected, and `magic` props exists, it should be truncated to predefined magic string, such as `JPEG`, or an number, representing `uninterested magic version`. If the `magic` props does not exists, it should be retrieved by `xstat` module.

**In old version, either hash/htime and magic are both exists, or they are both absent.**

#### uninterested magic version

Starting from current version (0.3), the responsibility of detecting file type is assigned to `xstat` module.

It works as follows:

1. using `file` command to extract magic string.
2. if magic string starts with `JPEG image data`, the magic prop is assigned to `JPEG` (string).
3. if magic string does not starts with `JPEG image data` the magic prop is assigned to 0 (number).

0 indicates that in version 0, the type of this file is not interested. For files that has type not interested, the upper layer may not calculate their hash at all, since there is no use case.

This value should be hard-coded as a constant in source code. Named as `UNINTERESTED_MAGIC_VERSION`.

Next time (version), if we are interested also gif file, we bump this number to 1. When `xstat` module read a `xattr` with UNINTERESTED_MAGIC_VERSION less than 1, it knows that it should run `file` command against the file again, to see if magic string starts with `GIF image data`, if so, the magic prop should be set to `GIF`, otherwise, it should be set to new UNINTERESTED_MAGIC_VERSION, which is 1, to avoid running `file` command again during next `xstat` operation.

### xstat in JavaScript Object format

`xstat` object in JavaScript object format, is a `fs.stat` object, merged with `xattr` props.

example:

```js
// props in fs.stat is not listed
{
  uuid: 'd10a0dce-7ff6-4cdd-b02b-f74fc863b0fd',
  writelist: [],
  readlist: [],
  hash: '7803e8fa1b804d40d412bcd28737e3ae027768ecc559b51a284fbcadcd0e21be',
  magic: 'JPEG'
}
```

**uuid, writelist, readlist**

same as JSON counterpart.

**hash and htime**

`htime` is silently dropped. `xstat` module uses this prop internally. It never returns this prop to upper layer.

**magic**

optional!

If magic is a predefined string, it is included in `xstat` object. If it is UNINTERESTED_MAGIC_VERSION, it is dropped.

## Functions

### readTimeStamp (X)

deprecated, use `readXstat` instead.

### readXstat

This is the main function of `xstat` module.

```js
// target is a path
// callback is (err, xstat) => {...}
function readXstat(target, callback)
```
**change**

This definition is different from previous version in that it eliminate an optional parameter `opts`, which simplifies its implementation.

There is no use case any more for testing if `xattr` exists on given file or folder, and if not exist, do nothing.

The `owner` prop is removed out of `xattr` definition in this version. So, no need to provide `opts` for setting default owner.

Also, no case found that it is necessary to override default implicit permission or providing hash when creating `xttar` on new file. If the caller want to set permission or hash other than default one, it can always do so by calling `updateXattrHash` or `updateXattrPermission` again.

**behavior**

If the target does not have `xattr`, a new `xattr` is generated with random UUID, writelist and readlist set to null (implicit), and magic should be extract from `file` command and properly set, like (magic prop is optional):

```json
{
    "uuid": "c3340714-66af-488b-82df-05371376ad86",
    "writelist": null,
    "readlist": null,
    "magic": "JPEG"
}
```

If the target already have `xattr`, it should be validated, which means all props must be valid.

* uuid, must exist and be valid uuid string
* writelist: must exist, be uuid array (empty is OK), or null
* readlist: must exist and be uuid array (empty is OK), or null
* either writelist and readlist are both array, or they are both null
* writelist and readlist should be de-duplicated.
* if a uuid exists in both writelist and readlist, it should be removed out of readlist.
* magic, must exist, be a number or a predefined type string.
* hash and htime, both exist or both absent
* if hash and htime both exists, hash must be a valid sha256 string
* if hash and htime both exists, htime must be

If it is neither valid current version or valid old version, it is discarded. A brand new `xattr` should be generated.

If it has an old version (valid and has owner prop):

* if magic exists, it should be translated.
* if magic does not exist, it should be calculated.
* if hash / htime exists and valid, they should be reused.
* if hash / htime exists but not valid, either bad format or outdated, they should be discarded.

If the target already have new version `xattr`

* hash / htime props should be checked, and dropped if necessary.
* if magic is predefined string, intact.
* if magic is number, equals to or larger than current UNINTERESTED_MAGIC_VERSION, intact.
* if magic is number, less than current UNINTERESTED_MAGIC_VERSION, magic should be re-calculated.

This function should have plenty of unit testing, making sure both returned `xstat` object and `xattr` json are correct.

### updateXattrPermission

```js
function updateXattrPermission(target, uuid, writelist, readlist, callback)
```
writelist and readlist must be both null or both valid uuid array.

If a user is in both writelist and readlist, it should be removed out of readlist.

// piggyback hash checking?

### updateXattrHash

```js
function updateXattrHash(target, uuid, hash, htime, callback)
```

`htime` is used to make sure the hash value is correct, even if the file is modified when hashing the file.

Each time a job is allocated to calc hash, it should first retrieve the `mtime` before starting calculation. After the calculation is done, it should provide both `uuid` and `htime`, as well as calculated hash to invoke this function. This function will check the `mtime` again. If the timestamp is not equal, it knows that the hash cannot be used and return error.

### copyXattr

```js
function copyXattr(dst, src, callback)
```

This function is used for overwriting an existing file with new one and keeping the uuid.
